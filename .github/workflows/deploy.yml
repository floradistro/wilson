name: Deploy Wilson OTA
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun test --if-present

      - name: Build project
        run: bun run build

      - name: Get version from package.json
        id: version
        run: echo "version=$(cat package.json | jq -r '.version')" >> $GITHUB_OUTPUT

      - name: Create release bundle
        run: |
          mkdir -p dist/release
          cp -r src dist/release/
          cp package.json dist/release/
          cp bun.lockb dist/release/
          echo "${{ steps.version.outputs.version }}" > dist/release/VERSION
          cd dist/release && tar -czf ../wilson-${{ steps.version.outputs.version }}.tar.gz .

      - name: Upload to Supabase Storage
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # Upload release bundle to Supabase storage for OTA updates
          curl -X POST \
            "$SUPABASE_URL/storage/v1/object/wilson-releases/wilson-${{ steps.version.outputs.version }}.tar.gz" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/gzip" \
            --data-binary @dist/wilson-${{ steps.version.outputs.version }}.tar.gz

      - name: Update latest version metadata
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Update version metadata in database
          curl -X POST \
            "$SUPABASE_URL/rest/v1/wilson_releases" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "{
              \"version\": \"${{ steps.version.outputs.version }}\",
              \"download_url\": \"$SUPABASE_URL/storage/v1/object/public/wilson-releases/wilson-${{ steps.version.outputs.version }}.tar.gz\",
              \"created_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
              \"is_latest\": true
            }"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Wilson v${{ steps.version.outputs.version }}
          body: |
            Automatic release of Wilson v${{ steps.version.outputs.version }}
            
            ## Changes
            - Auto-deployed from commit ${{ github.sha }}
            
            ## Installation
            ```bash
            curl -fsSL https://install.wilson.dev | sh
            # Or update existing installation:
            wilson update
            ```
          draft: false
          prerelease: false